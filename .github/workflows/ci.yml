name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-macos:
    name: Build & Test (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Build & Test macOS
        run: bash scripts/build-macos.sh

  test-app:
    name: Test App (macOS)
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v6
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Write .env file
        env:
          ENV_B64: ${{ secrets.ENV_B64 }}
        run: echo "$ENV_B64" | base64 --decode > test/testUITests/.env
      - name: Run TestPlan
        run: |
          xcodebuild test \
            -project test/test.xcodeproj \
            -scheme test \
            -testPlan TestPlan \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY=- \
            DEVELOPMENT_TEAM=""

  test-app-ios:
    name: Test App (iOS)
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v6
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Write .env file
        env:
          ENV_B64: ${{ secrets.ENV_B64 }}
        run: echo "$ENV_B64" | base64 --decode > test/testUITests/.env
      - name: Find iOS Simulator
        id: sim
        run: |
          xcrun simctl list runtimes
          xcrun simctl list devices available
          SIM_ID=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data['devices'].items():
              if 'iOS' in runtime:
                  for d in devices:
                      if d['isAvailable']:
                          print(d['udid'])
                          sys.exit(0)
          sys.exit(1)
          ")
          echo "sim_id=$SIM_ID" >> "$GITHUB_OUTPUT"
      - name: Run TestPlan
        run: |
          xcodebuild test \
            -project test/test.xcodeproj \
            -scheme test \
            -testPlan TestPlan \
            -destination 'platform=iOS Simulator,id=${{ steps.sim.outputs.sim_id }}' \
            CODE_SIGN_IDENTITY=- \
            DEVELOPMENT_TEAM=""

  build-ios:
    name: Build (iOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Build iOS
        run: bash scripts/build-ios.sh
